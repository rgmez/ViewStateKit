name: Update README SPM version

on:
  release:
    types: [published]

jobs:
  update-readme:
    name: Update README SPM `from:`
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Get tag
        id: get_tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Update README `from:` (Swift code block only)
        run: |
          echo "Updating README.md to use from: \"${TAG}\" inside the first Swift code block"
          # Replace the `from:` value only inside the first ```swift code block that contains `.package(`
          awk -v tag="$TAG" '
          BEGIN { in=0; done=0 }
          /^```swift/ && done==0 { in=1; print; next }
          /^```/ && in==1 { in=0; done=1; print; next }
          { if(in==1 && match($0, /from: "[^"]+"/)) { sub(/from: "[^"]+"/, "from: \"" tag "\""); print } else print }
          ' README.md > README.md.tmp && mv README.md.tmp README.md
          git --no-pager diff -- README.md || true

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: update README SPM version to ${TAG}" || echo "No changes to commit"
          git push
